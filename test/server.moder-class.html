<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Настройка классов</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 560px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(60, 72, 88, 0.08);
      padding: 32px 24px 24px 24px;
    }
    .logo {
      width: 120px;
      margin-bottom: 28px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      color: #2e3a59;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 24px;
    }
    .add-class-block {
      display: flex;
      gap: 10px;
      margin-bottom: 32px;
      justify-content: center;
    }
    .input-sm {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #dbe1e8;
      border-radius: 8px;
      font-size: 1rem;
      background: #f8fafb;
      transition: border .2s;
    }
    .input-sm:focus {
      border-color: #3b82f6;
      outline: none;
      background: #fff;
    }
    .input-xs {
      width: 80px;
      padding: 6px 8px;
      border: 1px solid #dbe1e8;
      border-radius: 8px;
      font-size: 1rem;
      background: #f8fafb;
      margin-right: 8px;
      transition: border .2s;
    }
    .input-xs:focus {
      border-color: #3b82f6;
      outline: none;
      background: #fff;
    }
    .btn {
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 9px 16px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background .15s;
    }
    .btn:hover {
      background: #2563eb;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #334155;
    }
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    .class-list {
      margin-top: 12px;
    }
    .class-block {
      border-radius: 10px;
      margin-bottom: 16px;
      background: #f0f6ff;
      box-shadow: 0 2px 6px rgba(60,72,88,0.06);
      padding: 0;
      overflow: hidden;
      border: none;
      transition: box-shadow .2s;
    }
    .class-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 16px 20px 16px 20px;
      background: #e0edff;
      font-size: 1.1rem;
      font-weight: 600;
      color: #234173;
      border: none;
      outline: none;
      transition: background .16s;
      user-select: none;
    }
    .class-header:active {
      background: #d1e5ff;
    }
    .class-actions {
      display: flex;
      gap: 6px;
    }
    .arrow {
      transition: transform .3s;
      font-size: 1.2rem;
      color: #3b82f6;
      margin-right: 8px;
    }
    .arrow.open {
      transform: rotate(90deg);
    }
    .students-section {
      padding: 16px 28px 20px 48px;
      background: #fafbff;
      border-top: 1px solid #e1e7ef;
      animation: fadeIn .3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px);}
      to { opacity: 1; transform: none;}
    }
    .edit-fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
      margin-top: 8px;
    }
    .edit-fields label {
      font-size: 1rem;
      color: #234173;
    }
    .edit-fields input[type="number"] {
      width: 80px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #dbe1e8;
      padding: 6px 8px;
      background: #f8fafb;
      margin-right: 12px;
      transition: border .2s;
    }
    .edit-fields input[type="number"]:focus {
      border-color: #3b82f6;
      outline: none;
      background: #fff;
    }
    @media (max-width: 600px) {
      .container { padding: 8px; }
      .students-section { padding: 12px 10px 16px 18px;}
      .class-header { padding: 12px 12px 12px 12px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://thumb.tildacdn.com/tild6539-3262-4636-b334-326130356633/-/format/webp/d_NEW_LOGO-Photoroom.png.webp" alt="Логотип">
    <h1>Управление классами</h1>
    <div class="add-class-block">
      <input id="newClassName" placeholder="Название нового класса" class="input-sm">
      <input id="newClassCount" type="number" min="0" placeholder="Кол-во учеников" class="input-xs">
      <input id="newClassAvg" type="number" min="0" max="5" step="0.01" placeholder="Средний балл" class="input-xs">
      <button class="btn" onclick="addClass()">Добавить класс</button>
    </div>
    <div class="class-list" id="classes"></div>
  </div>
  <script>
    // Local storage key
    const LS_KEY = 'moder_classes_v2';
    // Классы по умолчанию
    const DEFAULT_CLASSES = [
      { id: 1, name: '6ДЕМО', students: [], count: 0, avg: 0, graduate: false },
      { id: 2, name: '6-а', students: [], count: 0, avg: 0, graduate: false },
      { id: 3, name: '6-в', students: [], count: 0, avg: 0, graduate: false },
      { id: 4, name: '7-б', students: [], count: 0, avg: 0, graduate: false },
      { id: 5, name: '9-Ә', students: [], count: 0, avg: 0, graduate: false },
      { id: 6, name: '11-а', students: [], count: 0, avg: 0, graduate: false },
      { id: 7, name: '11ДЕМО', students: [], count: 0, avg: 0, graduate: false },
    ];

    function loadClasses() {
      try {
        const saved = JSON.parse(localStorage.getItem(LS_KEY));
        if (Array.isArray(saved) && saved.length > 0) {
          classIdCounter = Math.max(1, ...saved.map(cls => cls.id)) + 1;
          return saved;
        }
      } catch (e) {}
      classIdCounter = Math.max(1, ...DEFAULT_CLASSES.map(cls => cls.id)) + 1;
      return JSON.parse(JSON.stringify(DEFAULT_CLASSES));
    }

    function saveClasses() {
      localStorage.setItem(LS_KEY, JSON.stringify(classes));
    }

    let classes = loadClasses();
    let classIdCounter = Math.max(8, ...classes.map(cls => cls.id + 1));
    let openClassId = null;
    let editMode = {};

    function renderClasses() {
      const classesDiv = document.getElementById('classes');
      classesDiv.innerHTML = '';
      classes.forEach(cls => {
        const block = document.createElement('div');
        block.className = 'class-block';

        const header = document.createElement('div');
        header.className = 'class-header';
        header.onclick = (e) => {
          if (e.target.tagName === 'BUTTON' || e.target.type === 'checkbox') return;
          openClassId = openClassId === cls.id ? null : cls.id;
          renderClasses();
        };

        const arrow = document.createElement('span');
        arrow.className = 'arrow' + (openClassId === cls.id ? ' open' : '');
        arrow.innerHTML = '▶';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = cls.name;
        nameSpan.style.flex = '1';

        // Краткая инфа по классу
        const infoSpan = document.createElement('span');
        infoSpan.style.marginLeft = '12px';
        infoSpan.style.fontSize = '0.97rem';
        infoSpan.style.color = '#3b82f6';
        infoSpan.textContent = `Учеников: ${cls.count || cls.students.length}, Средний балл: ${cls.avg || 0}`;

        const actions = document.createElement('div');
        actions.className = 'class-actions';

        // Edit
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary';
        editBtn.textContent = editMode[cls.id] ? 'Сохранить' : 'Редактировать';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          if (editMode[cls.id]) {
            saveEditClass(cls.id);
          } else {
            editMode = {};
            editMode[cls.id] = true;
            renderClasses();
          }
        };
        actions.appendChild(editBtn);

        // Remove
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-secondary';
        removeBtn.textContent = 'Удалить';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          removeClass(cls.id);
        };
        actions.appendChild(removeBtn);

        header.appendChild(arrow);
        header.appendChild(nameSpan);
        header.appendChild(infoSpan);
        header.appendChild(actions);

        block.appendChild(header);

        // Страница класса
        if (openClassId === cls.id) {
          const studentsSection = document.createElement('div');
          studentsSection.className = 'students-section';

          // Graduate checkbox для 9 и 11
          const classNum = getClassNum(cls.name);
          if (classNum === 9 || classNum === 11) {
            const gradBlock = document.createElement('div');
            gradBlock.className = 'graduate-checkbox-block';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `graduate-checkbox-${cls.id}`;
            checkbox.checked = !!cls.graduate;
            checkbox.onclick = (e) => {
              cls.graduate = checkbox.checked;
              saveClasses();
            };
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = 'Выпускной класс';
            gradBlock.appendChild(checkbox);
            gradBlock.appendChild(label);
            studentsSection.appendChild(gradBlock);
          }

          // Редактирование класса
          if (editMode[cls.id]) {
            const editFields = document.createElement('div');
            editFields.className = 'edit-fields';
            // Название
            const nameLabel = document.createElement('label');
            nameLabel.textContent = 'Название класса';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = cls.name;
            nameInput.className = 'input-sm';
            nameInput.id = `edit-name-${cls.id}`;
            editFields.appendChild(nameLabel);
            editFields.appendChild(nameInput);

            // Кол-во учеников
            const countLabel = document.createElement('label');
            countLabel.textContent = 'Кол-во учеников';
            const countInput = document.createElement('input');
            countInput.type = 'number';
            countInput.min = 0;
            countInput.value = cls.count || cls.students.length;
            countInput.className = 'input-xs';
            countInput.id = `edit-count-${cls.id}`;
            editFields.appendChild(countLabel);
            editFields.appendChild(countInput);

            // Средний балл
            const avgLabel = document.createElement('label');
            avgLabel.textContent = 'Средний балл';
            const avgInput = document.createElement('input');
            avgInput.type = 'number';
            avgInput.step = "0.01";
            avgInput.min = 0;
            avgInput.max = 5;
            avgInput.value = cls.avg || 0;
            avgInput.className = 'input-xs';
            avgInput.id = `edit-avg-${cls.id}`;
            editFields.appendChild(avgLabel);
            editFields.appendChild(avgInput);

            studentsSection.appendChild(editFields);
          }

          // Список учеников
          const ul = document.createElement('ul');
          ul.className = 'students-list';
          cls.students.forEach((student, i) => {
            const li = document.createElement('li');
            li.textContent = student;
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-secondary';
            delBtn.style.fontSize = '0.92em';
            delBtn.textContent = 'Удалить';
            delBtn.onclick = () => removeStudent(cls.id, i);
            li.appendChild(delBtn);
            ul.appendChild(li);
          });
          studentsSection.appendChild(ul);

          // Добавить ученика
          const addStudentBlock = document.createElement('div');
          addStudentBlock.className = 'add-student-block';
          const input = document.createElement('input');
          input.className = 'input-sm';
          input.id = `student-input-${cls.id}`;
          input.placeholder = 'Добавить ученика';
          input.addEventListener('keydown', function(e){
            if(e.key === 'Enter') addStudent(cls.id);
          });
          const addBtn = document.createElement('button');
          addBtn.className = 'btn';
          addBtn.textContent = 'Добавить';
          addBtn.onclick = () => addStudent(cls.id);
          addStudentBlock.appendChild(input);
          addStudentBlock.appendChild(addBtn);
          studentsSection.appendChild(addStudentBlock);

          block.appendChild(studentsSection);

          setTimeout(() => {
            const el = document.getElementById(`student-input-${cls.id}`);
            if (el) el.focus();
          }, 20);
        }

        classesDiv.appendChild(block);
      });
    }

    function addClass() {
      const nameInput = document.getElementById('newClassName');
      const countInput = document.getElementById('newClassCount');
      const avgInput = document.getElementById('newClassAvg');
      const name = nameInput.value.trim();
      const count = Number(countInput.value);
      const avg = Number(avgInput.value);

      if (!name) return alert('Введите название класса');
      if (isNaN(count) || count < 0) return alert('Введите корректное количество учеников');
      if (isNaN(avg) || avg < 0 || avg > 5) return alert('Введите средний балл от 0 до 5');

      classes.push({
        id: classIdCounter++,
        name,
        students: [],
        count,
        avg,
        graduate: false
      });
      nameInput.value = '';
      countInput.value = '';
      avgInput.value = '';
      openClassId = classes[classes.length-1].id;
      saveClasses();
      renderClasses();
    }

    function removeClass(id) {
      if (!confirm('Удалить класс?')) return;
      classes = classes.filter(cls => cls.id !== id);
      if (openClassId === id) openClassId = null;
      saveClasses();
      renderClasses();
    }

    function saveEditClass(id) {
      const cls = classes.find(cls => cls.id === id);
      const newName = document.getElementById(`edit-name-${id}`).value.trim();
      const newCount = Number(document.getElementById(`edit-count-${id}`).value);
      const newAvg = Number(document.getElementById(`edit-avg-${id}`).value);

      if (!newName) return alert('Название не может быть пустым');
      if (isNaN(newCount) || newCount < 0) return alert('Количество учеников должно быть >= 0');
      if (isNaN(newAvg) || newAvg < 0 || newAvg > 5) return alert('Средний балл должен быть от 0 до 5');

      cls.name = newName;
      cls.count = newCount;
      cls.avg = newAvg;
      // graduate reset если класс не 9 или 11
      const classNum = getClassNum(cls.name);
      if (classNum !== 9 && classNum !== 11) cls.graduate = false;
      editMode = {};
      saveClasses();
      renderClasses();
    }

    function addStudent(classId) {
      const input = document.getElementById(`student-input-${classId}`);
      if (!input) return;
      const name = input.value.trim();
      if (!name) return alert('Введите имя ученика');
      const cls = classes.find(cls => cls.id === classId);
      cls.students.push(name);
      input.value = '';
      cls.count = cls.students.length;
      saveClasses();
      renderClasses();
      openClassId = classId;
      setTimeout(() => {
        const el = document.getElementById(`student-input-${classId}`);
        if (el) el.focus();
      }, 20);
    }

    function removeStudent(classId, studentIndex) {
      const cls = classes.find(cls => cls.id === classId);
      cls.students.splice(studentIndex, 1);
      cls.count = cls.students.length;
      saveClasses();
      renderClasses();
      openClassId = classId;
    }

    function getClassNum(name) {
      const m = String(name).trim().match(/^(\d{1,2})\s?([А-ЯA-Z\-]*)/i);
      return m ? Number(m[1]) : NaN;
    }

    renderClasses();
    window.addEventListener('beforeunload', saveClasses);
  </script>
</body>
</html>
